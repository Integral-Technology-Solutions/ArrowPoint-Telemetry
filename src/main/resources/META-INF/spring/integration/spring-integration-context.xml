<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:int="http://www.springframework.org/schema/integration"
	xmlns:int-file="http://www.springframework.org/schema/integration/file"
	xmlns:int-ip="http://www.springframework.org/schema/integration/ip"
	xmlns:int-jms="http://www.springframework.org/schema/integration/jms"
	xmlns:context="http://www.springframework.org/schema/context"
	xmlns:oxm="http://www.springframework.org/schema/oxm"
	xsi:schemaLocation="
		http://www.springframework.org/schema/integration http://www.springframework.org/schema/integration/spring-integration.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
		http://www.springframework.org/schema/integration/file http://www.springframework.org/schema/integration/file/spring-integration-file.xsd
		http://www.springframework.org/schema/integration/ip http://www.springframework.org/schema/integration/ip/spring-integration-ip.xsd
		http://www.springframework.org/schema/integration/jms http://www.springframework.org/schema/integration/jms/spring-integration-jms.xsd
		http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd
		http://www.springframework.org/schema/oxm http://www.springframework.org/schema/oxm/spring-oxm.xsd">


	
	<int:logging-channel-adapter id="payloadLogger"
		level="INFO"
		expression="'Payload:' + payload + ', Headers:' + headers" />

	
	<!-- <int:poller default="true" fixed-rate="5000" max-messages-per-poll="1" />
		
	 <int-file:inbound-channel-adapter id="csvIn" directory="file://C:/tmp" prevent-duplicates="true" filename-pattern="*.csv" />
 	</int-file:inbound-channel-adapter> -->
 	
 	<int-file:file-to-string-transformer input-channel="csvIn" output-channel="csvOut" delete-files="false" charset="UTF-8" />
 	
 	<int:splitter id="csvSplitter"
		input-channel="csvOut" 
		output-channel="csvUdpOut" 
		ref="csvLineSplitter">
	</int:splitter>
	
	<int-ip:udp-outbound-channel-adapter id="csvUdpOut" host="239.255.60.60" port="4876" multicast="true" /> -->



	
	
	<int-file:inbound-channel-adapter id="csvIn" directory="file:///C:/temp/arrow" filename-pattern="*.csv" prevent-duplicates="true">
		<int:poller id="poller" fixed-rate="5000" />
	</int-file:inbound-channel-adapter>

	<int-file:file-to-string-transformer input-channel="csvIn" output-channel="csvOut" delete-files="false" charset="UTF-8" />

	
	 
	 <int:splitter id="csvSplitter" input-channel="csvOut" output-channel="csvLineOut" ref="csvLineSplitter">
	</int:splitter>

 	
	
	<int:service-activator id="canPacketBuilder" 
		input-channel="csvLineOut"
		output-channel="canPacketChannel" 
		ref="canPacketBuilderService" /> 

	
 	
 	<int-ip:udp-inbound-channel-adapter id="bridgeReceiver"
		channel="canbusBridgeChannel" port="4876" receive-buffer-size="1500"
		multicast="true" check-length="false" lookup-host="false"
		multicast-address="239.255.60.60" />

	
	
	<int:channel id="canbusBridgeChannel">
	</int:channel>
	
	
	
	<int:payload-deserializing-transformer id="udpPacketDeserializingTransformer"
		input-channel="canbusBridgeChannel"
		deserializer="udpPacketDeserializer"
		output-channel="udpPacketChannel">
	</int:payload-deserializing-transformer>
	
	
	
	<int:channel id="udpPacketChannel"
		datatype="au.com.teamarrow.canbus.model.UdpPacket">
	</int:channel>
	
	
	
	<int:splitter id="canPacketSplitRouter"
		input-channel="udpPacketChannel" 
		output-channel="canPacketChannel" 
		ref="canPacketSplitter">
	</int:splitter>
	
	
	
	<int:channel id="canPacketChannel"
		datatype="au.com.teamarrow.canbus.model.CanPacket">
	</int:channel>
	
	
	
	<int:splitter id="measurementDataSplitRouter"
		input-channel="canPacketChannel" 
		output-channel="measurementDataChannel" 
		ref="measurementDataSplitter">
	</int:splitter>
	
	

	
	<int:channel id="measurementAggregatedDataChannel"
		datatype="au.com.teamarrow.model.MeasurementData">
		 <int:interceptors>
        	<int:wire-tap channel="payloadLogger"/>
    	</int:interceptors>
	</int:channel>

	
	
	<int:recipient-list-router id="measurementDataRouter"
		input-channel="measurementAggregatedDataChannel">
		<int:recipient channel="filteredMeasurementDataChannel" selector-expression="payload.dataPointCanId le 1536 or payload.dataPointCanId ge 1551" /> <!-- no 0x40b with 1027 -->
		<int:recipient channel="nullChannel" selector-expression="payload.dataPointCanId ge 1537 and payload.dataPointCanId le 1550" />
	</int:recipient-list-router>

	
	<int:channel id="filteredMeasurementDataChannel"
		datatype="au.com.teamarrow.model.MeasurementData">
	</int:channel>
	
	
	<int:service-activator id="measurementDataServiceActivator" 
		input-channel="filteredMeasurementDataChannel"
		output-channel="nullChannel" 
		ref="measurementDataService" />


	<bean id="aggregatorBean" class="au.com.teamarrow.service.impl.MeasurementDataAggregator"/>

	
	<int:channel id="measurementDataChannel"
		datatype="au.com.teamarrow.model.MeasurementData">
	</int:channel>
	
	<int:channel id="measurementDataChannelWithHeader"
				datatype="au.com.teamarrow.model.MeasurementData">
	</int:channel>
	
	<int:header-enricher input-channel="measurementDataChannel" output-channel="measurementDataChannelWithHeader">
        <int:correlation-id expression="payload.dataPointCanId" overwrite="true" />
    </int:header-enricher>
	
	<bean id="releaseStrategy" class="org.springframework.integration.aggregator.TimeoutCountSequenceSizeReleaseStrategy">
    	<!-- Release when: 10 Messages ... or ... -->
    	<constructor-arg index="0" value="10" />
    	<!-- ... 1 second since first request -->
    	<constructor-arg index="1" value="1000" />
	</bean>	
			
	<int:aggregator id="messageDataAggregator" 
		ref="aggregatorBean"
		method="collect"
		input-channel="measurementDataChannelWithHeader"
		output-channel="measurementAggregatedDataChannel" 		
		release-strategy="releaseStrategy"
		expire-groups-upon-completion="true"			
		send-partial-result-on-expiry="true" 
		send-timeout="86420000"
		discard-channel="nullChannel">        
    </int:aggregator>




	<!-- <int:recipient-list-router id="canPacketRouter"	input-channel="canPacketChannel">
		<int:recipient channel="waveSculptorChannel"
                       selector-expression="payload.idBase10 le 1074" /> no 0x40b with 1027
		<int:recipient channel="payloadLogger" selector-expression="payload.idBase10 gt 1074" />
	</int:recipient-list-router> -->

	<!-- See also: http://static.springsource.org/spring-integration/reference/htmlsingle/#service-activator
		http://www.eaipatterns.com/MessagingAdapter.html -->
<!-- 	<int:service-activator id="canbusServiceActivator"  -->
<!-- 		input-channel="waveSculptorChannel" -->
<!-- 		output-channel="nullChannel"  -->
<!-- 		ref="canbusService" /> -->

	

	
	<!-- <int:channel id="waveSculptorChannel" datatype="au.com.teamarrow.canbus.model.CanPacket">
	</int:channel> -->
	

	
	
</beans>
